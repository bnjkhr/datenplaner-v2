<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Datenprodukt Planer - Read-Only Ansicht für Confluence"
    />
    <title>Datenprodukt Planer - Read-Only (Secure)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .gradient-bg {
        background: linear-gradient(
          135deg,
          #f8fafc 0%,
          rgba(239, 246, 255, 0.3) 100%
        );
      }
      .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      .text-gradient {
        background: linear-gradient(45deg, #2563eb, #4f46e5);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .status-connected {
        background-color: #10b981;
      }
      .status-disconnected {
        background-color: #ef4444;
      }
      .status-loading {
        background-color: #f59e0b;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body class="gradient-bg min-h-screen">
    <div id="app">
      <!-- Header -->
      <header
        class="bg-white/80 backdrop-blur-md shadow-lg border-b border-gray-100 sticky top-0 z-30"
      >
        <nav class="container mx-auto px-6 py-4">
          <div class="flex justify-between items-center">
            <div class="text-2xl font-bold text-gradient">
              Datenprodukt Planer - Secure
            </div>
            <div class="flex items-center gap-4">
              <div class="flex items-center text-sm text-gray-600">
                <span
                  class="status-indicator status-loading"
                  id="connection-status"
                ></span>
                <span id="connection-text">Verbinde...</span>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="showView('team')"
                  id="nav-team"
                  class="px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white"
                >
                  Team-Übersicht
                </button>
                <button
                  onclick="showView('analytics')"
                  id="nav-analytics"
                  class="px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-blue-50"
                >
                  Auswertungen
                </button>
              </div>
            </div>
          </div>
        </nav>
      </header>

      <!-- Main Content -->
      <main id="main-content" class="container mx-auto px-6 py-8">
        <div class="loading-container text-center py-20">
          <div class="loading mx-auto mb-4"></div>
          <p class="text-gray-600">Lade sichere Daten...</p>
        </div>
      </main>
    </div>

    <script>
      // Konfiguration für API-Endpunkt
      const API_BASE_URL = window.location.origin.includes("localhost")
        ? "http://localhost:3002"
        : "https://datenplaner-v2.vercel.app/"; // Produktions-URL hier anpassen

      let currentData = null;
      let currentView = "team";
      let isConnected = false;
      let lastUpdate = null;

      // Connection Status updaten
      function updateConnectionStatus(status, text) {
        const indicator = document.getElementById("connection-status");
        const textElement = document.getElementById("connection-text");

        indicator.className = `status-indicator status-${status}`;
        textElement.textContent = text;
        isConnected = status === "connected";
      }

      // API Call mit Error Handling
      async function apiCall(endpoint) {
        try {
          updateConnectionStatus("loading", "Lädt...");
          const response = await fetch(
            `${API_BASE_URL}/api/readonly/${endpoint}`
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || "API returned error");
          }

          updateConnectionStatus(
            "connected",
            `Verbunden (${new Date(data.timestamp).toLocaleTimeString(
              "de-DE"
            )})`
          );
          lastUpdate = data.timestamp;
          return data;
        } catch (error) {
          console.error("API Call failed:", error);
          updateConnectionStatus("disconnected", "Verbindungsfehler");
          throw error;
        }
      }

      // Daten von sicherer API laden
      async function loadSecureData() {
        try {
          const response = await apiCall("data");
          return response.data;
        } catch (error) {
          console.error("Fehler beim Laden der sicheren Daten:", error);

          // Fallback zu Demo-Daten bei Verbindungsproblemen
          updateConnectionStatus("disconnected", "Demo-Modus");
          return {
            personen: [
              {
                id: 1,
                name: "Max Mustermann",
                email: "max@example.com",
                wochenstunden: 31,
                skillIds: [1, 2],
              },
              {
                id: 2,
                name: "Anna Schmidt",
                email: "anna@example.com",
                wochenstunden: 35,
                skillIds: [2, 3],
              },
              {
                id: 3,
                name: "Tom Weber",
                email: "tom@example.com",
                wochenstunden: 31,
                skillIds: [1, 3],
              },
            ],
            skills: [
              { id: 1, name: "Python", color: "#3776ab" },
              { id: 2, name: "Data Science", color: "#ff6b35" },
              { id: 3, name: "Machine Learning", color: "#4caf50" },
            ],
            datenprodukte: [
              { id: 1, name: "Customer Analytics" },
              { id: 2, name: "Sales Dashboard" },
              { id: 3, name: "ML Pipeline" },
            ],
            rollen: [
              { id: 1, name: "Data Scientist" },
              { id: 2, name: "Analytics Engineer" },
              { id: 3, name: "ML Engineer" },
            ],
            zuordnungen: [
              {
                id: 1,
                personId: 1,
                datenproduktId: 1,
                rolleId: 1,
                stunden: 20,
              },
              {
                id: 2,
                personId: 1,
                datenproduktId: 2,
                rolleId: 2,
                stunden: 15,
              },
              {
                id: 3,
                personId: 2,
                datenproduktId: 2,
                rolleId: 1,
                stunden: 25,
              },
              {
                id: 4,
                personId: 3,
                datenproduktId: 3,
                rolleId: 3,
                stunden: 31,
              },
            ],
          };
        }
      }

      function showView(view) {
        currentView = view;
        updateNavigation();
        if (view === "team") {
          renderTeamView();
        } else {
          renderAnalyticsView();
        }
      }

      function updateNavigation() {
        const teamBtn = document.getElementById("nav-team");
        const analyticsBtn = document.getElementById("nav-analytics");

        if (currentView === "team") {
          teamBtn.className =
            "px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white";
          analyticsBtn.className =
            "px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-blue-50";
        } else {
          teamBtn.className =
            "px-4 py-2 rounded-lg text-sm font-semibold text-gray-600 hover:bg-blue-50";
          analyticsBtn.className =
            "px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 text-white";
        }
      }

      function getWorkloadData() {
        if (!currentData) return [];

        return currentData.personen.map((person) => {
          const assignments = currentData.zuordnungen.filter(
            (z) => z.personId === person.id
          );
          const gebuchteStunden = assignments.reduce(
            (sum, a) => sum + (a.stunden || 0),
            0
          );
          const auslastung =
            (gebuchteStunden / (person.wochenstunden || 31)) * 100;

          return {
            ...person,
            gebuchteStunden,
            auslastung: Math.round(auslastung * 10) / 10,
            status:
              auslastung > 100
                ? "overbooked"
                : auslastung < 20
                ? "underbooked"
                : "normal",
          };
        });
      }

      function renderTeamView() {
        if (!currentData) return;

        const workloadData = getWorkloadData();
        const totalPersons = currentData.personen.length;
        const assignedPersons = currentData.personen.filter((p) =>
          currentData.zuordnungen.some((z) => z.personId === p.id)
        ).length;
        const overbookedPersons = workloadData.filter(
          (p) => p.status === "overbooked"
        ).length;

        document.getElementById("main-content").innerHTML = `
          <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Team-Übersicht</h1>
            <p class="text-gray-600">Sichere Live-Daten über Backend-API</p>
            <div class="mt-2 text-sm ${
              isConnected ? "text-green-600" : "text-orange-600"
            }">
              ${
                isConnected
                  ? "✓ Sichere Verbindung aktiv"
                  : "⚠ Demo-Modus (Backend nicht erreichbar)"
              }
              ${
                lastUpdate
                  ? ` • Letzte Aktualisierung: ${new Date(
                      lastUpdate
                    ).toLocaleString("de-DE")}`
                  : ""
              }
            </div>
          </div>

          <!-- Statistics -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                  <span class="text-blue-600 text-lg">👥</span>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Gesamt</p>
                  <p class="text-2xl font-semibold text-gray-900">${totalPersons}</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 card-shadow">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                  <span class="text-green-600 text-lg">✅</span>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Mit Zuordnung</p>
                  <p class="text-2xl font-semibold text-gray-900">${assignedPersons}</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 card-shadow">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                  <span class="text-orange-600 text-lg">⚠️</span>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Überbucht</p>
                  <p class="text-2xl font-semibold text-gray-900">${overbookedPersons}</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white rounded-xl p-6 card-shadow">
              <div class="flex items-center">
                <div class="w-8 h-8 ${
                  isConnected ? "bg-green-100" : "bg-gray-100"
                } rounded-lg flex items-center justify-center mr-4">
                  <span class="${
                    isConnected ? "text-green-600" : "text-gray-600"
                  } text-lg">${isConnected ? "🔒" : "📱"}</span>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-500">Status</p>
                  <p class="text-sm font-semibold text-gray-900">${
                    isConnected ? "Live" : "Demo"
                  }</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Team List -->
          <div class="bg-white rounded-xl card-shadow">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h2 class="text-lg font-semibold text-gray-900">Team-Mitglieder (${totalPersons})</h2>
              <button onclick="refreshData()" class="px-3 py-1 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                🔄 Aktualisieren
              </button>
            </div>
            <div class="divide-y divide-gray-100">
              ${workloadData
                .map((person) => {
                  const assignments = currentData.zuordnungen.filter(
                    (z) => z.personId === person.id
                  );
                  const personSkills = (person.skillIds || [])
                    .map((skillId) =>
                      currentData.skills.find((s) => s.id === skillId)
                    )
                    .filter(Boolean);

                  const statusClass =
                    person.status === "overbooked"
                      ? "text-red-600 bg-red-50"
                      : person.status === "underbooked"
                      ? "text-orange-600 bg-orange-50"
                      : "text-green-600 bg-green-50";

                  return `
                  <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                          <h3 class="text-lg font-semibold text-gray-900">${
                            person.name
                          }</h3>
                          <div class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold ${statusClass}">
                            ${person.auslastung}% (${person.gebuchteStunden}h/${
                    person.wochenstunden || 31
                  }h)
                          </div>
                        </div>
                        
                        ${
                          person.email
                            ? `<p class="text-sm text-gray-600 mb-3">${person.email}</p>`
                            : ""
                        }

                        ${
                          personSkills.length > 0
                            ? `
                          <div class="mb-3">
                            <p class="text-xs font-medium text-gray-500 mb-1">Skills:</p>
                            <div class="flex flex-wrap gap-1">
                              ${personSkills
                                .map(
                                  (skill) => `
                                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium text-gray-700 border"
                                      style="background-color: ${skill.color}20; border-color: ${skill.color}40">
                                  ${skill.name}
                                </span>
                              `
                                )
                                .join("")}
                            </div>
                          </div>
                        `
                            : ""
                        }

                        ${
                          assignments.length > 0
                            ? `
                          <div>
                            <p class="text-xs font-medium text-gray-500 mb-2">Zuordnungen:</p>
                            <div class="space-y-1">
                              ${assignments
                                .map((assignment) => {
                                  const produkt =
                                    currentData.datenprodukte.find(
                                      (dp) =>
                                        dp.id === assignment.datenproduktId
                                    );
                                  const rolle = currentData.rollen.find(
                                    (r) => r.id === assignment.rolleId
                                  );
                                  return `
                                  <div class="text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">
                                    <span class="font-medium">${
                                      produkt?.name || "Unbekanntes Produkt"
                                    }</span>
                                    <span class="text-gray-500"> als </span>
                                    <span class="font-medium">${
                                      rolle?.name || "Unbekannte Rolle"
                                    }</span>
                                    <span class="text-gray-500"> • ${
                                      assignment.stunden || 0
                                    }h/Woche</span>
                                  </div>
                                `;
                                })
                                .join("")}
                            </div>
                          </div>
                        `
                            : '<p class="text-sm text-gray-500 italic">Keine Zuordnungen</p>'
                        }
                      </div>
                    </div>
                  </div>
                `;
                })
                .join("")}
            </div>
          </div>
        `;
      }

      function renderAnalyticsView() {
        if (!currentData) return;

        const workloadData = getWorkloadData().sort(
          (a, b) => b.auslastung - a.auslastung
        );

        document.getElementById("main-content").innerHTML = `
          <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Team-Auswertungen</h1>
            <p class="text-gray-600">Sichere Analyse über Backend-API</p>
            <div class="mt-2 text-sm ${
              isConnected ? "text-green-600" : "text-orange-600"
            }">
              ${
                isConnected
                  ? "✓ Sichere Verbindung aktiv"
                  : "⚠ Demo-Modus (Backend nicht erreichbar)"
              }
            </div>
          </div>

          <!-- Auslastungsübersicht -->
          <div class="bg-white rounded-xl card-shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
              <h2 class="text-lg font-semibold text-gray-900">Auslastungsübersicht</h2>
              <button onclick="refreshData()" class="px-3 py-1 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors">
                🔄 Aktualisieren
              </button>
            </div>
            <div class="p-6">
              <p class="text-sm text-gray-600 mb-4">
                Sortiert nach Auslastung (hoch → niedrig) • ${
                  workloadData.length
                } Personen
              </p>
              
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                ${workloadData
                  .map((person) => {
                    const bgClass =
                      person.status === "overbooked"
                        ? "bg-gradient-to-br from-orange-50 to-red-50 border-orange-200"
                        : person.status === "underbooked"
                        ? "bg-gradient-to-br from-red-50 to-red-100 border-red-200"
                        : "bg-gradient-to-br from-green-50 to-emerald-50 border-emerald-200";

                    const statusClass =
                      person.status === "overbooked"
                        ? "bg-orange-200 text-orange-800"
                        : person.status === "underbooked"
                        ? "bg-red-200 text-red-800"
                        : "bg-emerald-200 text-emerald-800";

                    const progressClass =
                      person.status === "overbooked"
                        ? "bg-gradient-to-r from-orange-400 to-red-500"
                        : person.status === "underbooked"
                        ? "bg-gradient-to-r from-red-400 to-red-500"
                        : "bg-gradient-to-r from-emerald-400 to-emerald-500";

                    return `
                    <div class="p-4 rounded-xl border-2 transition-all hover:shadow-md ${bgClass}">
                      <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-900 text-sm truncate">${
                          person.name
                        }</h3>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${statusClass}">
                          ${person.auslastung}%
                        </span>
                      </div>
                      
                      <div class="space-y-2">
                        <div class="flex justify-between text-xs text-gray-600">
                          <span>Gebucht:</span>
                          <span class="font-medium">${
                            person.gebuchteStunden
                          }h</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600">
                          <span>Verfügbar:</span>
                          <span class="font-medium">${
                            person.wochenstunden || 31
                          }h</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="w-full bg-white/60 rounded-full h-2 overflow-hidden">
                          <div class="h-full rounded-full transition-all duration-500 ${progressClass}"
                               style="width: ${Math.min(
                                 person.auslastung,
                                 100
                               )}%"></div>
                        </div>
                        
                        ${
                          person.auslastung > 100
                            ? `
                          <div class="text-xs text-orange-700 font-medium">
                            ⚠️ Überbucht um ${Math.round(
                              person.auslastung - 100
                            )}%
                          </div>
                        `
                            : ""
                        }
                        ${
                          person.status === "underbooked" &&
                          person.gebuchteStunden > 0
                            ? `
                          <div class="text-xs text-red-700 font-medium">
                            📉 Unterausgelastet
                          </div>
                        `
                            : ""
                        }
                        ${
                          person.gebuchteStunden === 0
                            ? `
                          <div class="text-xs text-gray-500 font-medium">
                            💤 Nicht zugewiesen
                          </div>
                        `
                            : ""
                        }
                      </div>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            </div>
          </div>

          <!-- Skill-Analyse -->
          <div class="bg-white rounded-xl card-shadow">
            <div class="px-6 py-4 border-b border-gray-100">
              <h2 class="text-lg font-semibold text-gray-900">Skill-Verteilung</h2>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                ${currentData.skills
                  .map((skill) => {
                    const anzahl = currentData.personen.filter((p) =>
                      (p.skillIds || []).includes(skill.id)
                    ).length;
                    return `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl">
                      <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${skill.color}"></div>
                        <span class="text-sm font-medium text-gray-800">${skill.name}</span>
                      </div>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-lg text-xs font-bold bg-white text-gray-700">
                        ${anzahl}
                      </span>
                    </div>
                  `;
                  })
                  .join("")}
              </div>
            </div>
          </div>
        `;
      }

      // Daten aktualisieren
      async function refreshData() {
        const buttons = document.querySelectorAll(
          'button[onclick="refreshData()"]'
        );
        buttons.forEach((btn) => {
          btn.innerHTML = "🔄 Lädt...";
          btn.disabled = true;
        });

        try {
          currentData = await loadSecureData();
          if (currentView === "team") {
            renderTeamView();
          } else {
            renderAnalyticsView();
          }
        } catch (error) {
          console.error("Fehler beim Aktualisieren:", error);
        }
      }

      // Initialisierung
      async function init() {
        try {
          // Zuerst Health Check
          await apiCall("health");
          currentData = await loadSecureData();
          renderTeamView();
        } catch (error) {
          console.error("Fehler beim Laden der Daten:", error);
          // Fallback zu Demo-Daten
          currentData = await loadSecureData();
          renderTeamView();
        }
      }

      // App starten
      setTimeout(init, 1000);

      // Auto-refresh alle 5 Minuten (nur wenn verbunden)
      setInterval(() => {
        if (isConnected) {
          refreshData();
        }
      }, 5 * 60 * 1000);
    </script>
  </body>
</html>
